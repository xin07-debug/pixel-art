<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频精灵图生成器 (修复版)</title>
    <!-- 引入 Tailwind CSS (样式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel (让浏览器能运行 React 代码) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* 关键修复：不要使用 display: none，否则浏览器不会渲染视频帧导致黑屏。
           改为将其移出可视区域。
        */
        .video-hidden { 
            position: absolute;
            top: -9999px;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
            /* 保持一定的尺寸以触发渲染 */
            width: 320px; 
            height: 240px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // 图标组件
        const FilmIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>;
        const UploadIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const SettingsIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const ImageIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;
        const DownloadIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const AlertCircleIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;

        const App = () => {
          const [videoUrl, setVideoUrl] = useState(null);
          const [videoMeta, setVideoMeta] = useState({ duration: 0, width: 0, height: 0 });
          const [frameCount, setFrameCount] = useState(12);
          const [scale, setScale] = useState(0.25);
          const [columns, setColumns] = useState(4);
          const [isProcessing, setIsProcessing] = useState(false);
          const [progress, setProgress] = useState(0);
          const [generatedImage, setGeneratedImage] = useState(null);
          const [error, setError] = useState(null);

          const videoRef = useRef(null);
          const canvasRef = useRef(null);
          const fileInputRef = useRef(null);

          // 当帧数改变时，自动调整列数，但仅当用户没有手动大量调整过列数时才干扰（简单处理：每次都推荐最佳比例）
          useEffect(() => {
            if (frameCount > 0) {
              // 自动计算一个接近正方形的布局
              setColumns(Math.ceil(Math.sqrt(frameCount)));
            }
          }, [frameCount]);

          const handleFileChange = (event) => {
            const file = event.target.files[0];
            if (file) {
              // 清理旧的 URL 对象以释放内存
              if (videoUrl) URL.revokeObjectURL(videoUrl);
              
              const url = URL.createObjectURL(file);
              setVideoUrl(url);
              setGeneratedImage(null);
              setError(null);
              setProgress(0);
            }
          };

          const handleLoadedMetadata = () => {
            if (videoRef.current) {
              setVideoMeta({
                duration: videoRef.current.duration,
                width: videoRef.current.videoWidth,
                height: videoRef.current.videoHeight,
              });
            }
          };

          const seekToTime = (videoElement, time) => {
            return new Promise((resolve) => {
              // 超时保护：如果3秒内没有完成seek，强制继续，防止卡死
              const timeoutId = setTimeout(() => {
                  console.warn("Seek timeout, forcing next frame");
                  resolve();
              }, 3000);

              const onSeeked = () => {
                clearTimeout(timeoutId);
                videoElement.removeEventListener('seeked', onSeeked);
                // 关键修复：增加两帧的延迟，确保浏览器完全绘制了视频帧
                // 在 requestAnimationFrame 中再套一层，通常能解决大部分“黑屏”问题
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        resolve();
                    });
                });
              };
              videoElement.addEventListener('seeked', onSeeked);
              videoElement.currentTime = time;
            });
          };

          const generateSprite = async () => {
            if (!videoRef.current || !canvasRef.current) return;

            setIsProcessing(true);
            setProgress(0);
            setError(null);
            setGeneratedImage(null);

            try {
              const video = videoRef.current;
              const canvas = canvasRef.current;
              const ctx = canvas.getContext('2d');

              const totalFrames = parseInt(frameCount);
              const cols = parseInt(columns);
              const rows = Math.ceil(totalFrames / cols);

              const frameWidth = videoMeta.width * scale;
              const frameHeight = videoMeta.height * scale;
              
              const totalWidth = cols * frameWidth;
              const totalHeight = rows * frameHeight;

              // --- 防崩溃保护 ---
              // 浏览器的 canvas 高度或宽度通常限制在 32767px (2^15 - 1) 左右
              // 且总面积过大也会导致内存溢出
              if (totalHeight > 30000 || totalWidth > 30000) {
                 throw new Error(`预计生成尺寸 (${Math.round(totalWidth)}x${Math.round(totalHeight)}) 超过浏览器限制。请增加“每行列数”或减小“图片缩放”比例。`);
              }
              if ((totalWidth * totalHeight) > 16000 * 16000) { // 约 2.5亿像素，非常保守的限制
                 throw new Error("总像素量过大，浏览器可能崩溃。请减小“图片缩放”比例。");
              }

              canvas.width = totalWidth;
              canvas.height = totalHeight;

              ctx.clearRect(0, 0, canvas.width, canvas.height);

              // 间隔计算：+1 是为了避免取到视频最后一瞬间可能是黑屏
              const interval = videoMeta.duration / (totalFrames + 1);

              for (let i = 0; i < totalFrames; i++) {
                // 如果用户在中途想取消（这里没做取消按钮，但如果组件卸载了需要保护）
                if (!videoRef.current) break;

                const time = interval * (i + 1);
                await seekToTime(video, time);

                const x = (i % cols) * frameWidth;
                const y = Math.floor(i / cols) * frameHeight;

                // 绘制当前帧
                // 安全检查：如果视频没有准备好，就不绘制，防止报错
                if (video.readyState >= 2) {
                    ctx.drawImage(video, 0, 0, videoMeta.width, videoMeta.height, x, y, frameWidth, frameHeight);
                }
                
                // 更新进度
                setProgress(Math.round(((i + 1) / totalFrames) * 100));
              }

              // 单独的 try-catch 块用于导出图片，因为这是跨域错误最常发生的地方
              try {
                  const dataUrl = canvas.toDataURL('image/png');
                  setGeneratedImage(dataUrl);
              } catch (e) {
                  console.error("导出图片失败", e);
                  throw new Error("生成失败：浏览器拒绝导出图片。这通常是因为视频文件被视为跨域资源。请尝试更换浏览器，或使用本地服务器运行。");
              }

            } catch (err) {
              console.error(err);
              setError(err.message || "生成过程中发生错误，请尝试减少帧数或降低缩放比例。");
            } finally {
              setIsProcessing(false);
            }
          };

          const downloadImage = () => {
            if (generatedImage) {
              const link = document.createElement('a');
              link.href = generatedImage;
              link.download = `sprite-sheet-${Date.now()}.png`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }
          };

          const formatTime = (seconds) => {
            if (!seconds) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
          };

          // 估算当前设置下的输出尺寸
          const estimatedW = Math.round(videoMeta.width * scale * columns);
          const estimatedH = Math.round(videoMeta.height * scale * Math.ceil(frameCount / columns));
          const isSizeWarning = estimatedW > 30000 || estimatedH > 30000;

          return (
            <div className="min-h-screen bg-gray-900 text-gray-100 font-sans p-4 md:p-8">
              <div className="max-w-6xl mx-auto space-y-8">
                
                <header className="flex flex-col md:flex-row items-center justify-between border-b border-gray-800 pb-6">
                  <div className="flex items-center space-x-3 mb-4 md:mb-0">
                    <div className="p-3 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-500/20">
                      <FilmIcon className="w-8 h-8 text-white" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
                        视频精灵图生成器
                      </h1>
                      <p className="text-gray-400 text-sm">自动提取视频帧并合并为一张大图</p>
                    </div>
                  </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  
                  <div className="lg:col-span-1 space-y-6">
                    
                    {/* 上传区域 */}
                    <div 
                      className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors cursor-pointer group ${videoUrl ? 'border-green-500/50 bg-green-500/5' : 'border-gray-700 hover:border-indigo-500 hover:bg-gray-800'}`}
                      onClick={() => fileInputRef.current.click()}
                    >
                      <input 
                        type="file" 
                        ref={fileInputRef} 
                        accept="video/*" 
                        className="hidden" 
                        onChange={handleFileChange} 
                      />
                      {videoUrl ? (
                         <div className="flex flex-col items-center text-green-400">
                            <FilmIcon className="w-10 h-10 mb-2" />
                            <span className="font-medium">视频已加载</span>
                            <span className="text-xs text-gray-400 mt-1">点击更换视频</span>
                         </div>
                      ) : (
                        <div className="flex flex-col items-center text-gray-400 group-hover:text-indigo-400">
                          <UploadIcon className="w-10 h-10 mb-2" />
                          <span className="font-medium">点击上传视频</span>
                          <span className="text-xs text-gray-500 mt-1">支持 MP4, WebM, MOV</span>
                        </div>
                      )}
                    </div>

                    {/* 修复：移除了 crossOrigin="anonymous"。
                       对于本地 Blob URL，这个属性可能导致 tainted canvas 错误。
                    */}
                    <video 
                      ref={videoRef} 
                      src={videoUrl} 
                      onLoadedMetadata={handleLoadedMetadata} 
                      className="video-hidden" 
                      muted
                      playsInline
                      preload="auto"
                    />

                    {/* 设置面板 */}
                    <div className="bg-gray-800 rounded-xl p-6 border border-gray-700 space-y-6">
                      <div className="flex items-center space-x-2 text-lg font-semibold text-white mb-2">
                        <SettingsIcon className="w-5 h-5 text-indigo-400" />
                        <span>生成设置</span>
                      </div>

                      {/* 帧数滑块 */}
                      <div>
                        <div className="flex justify-between mb-2">
                          <label className="text-sm text-gray-300">提取帧数 (Frames)</label>
                          <span className="text-sm font-mono text-indigo-400">{frameCount}</span>
                        </div>
                        <input 
                          type="range" 
                          min="1" 
                          max="300" 
                          step="1"
                          value={frameCount} 
                          onChange={(e) => setFrameCount(Number(e.target.value))} 
                          className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                        />
                      </div>

                      {/* 缩放滑块 */}
                      <div>
                        <div className="flex justify-between mb-2">
                          <label className="text-sm text-gray-300">图片缩放 (Scale)</label>
                          <span className="text-sm font-mono text-indigo-400">{Math.round(scale * 100)}%</span>
                        </div>
                        <input 
                          type="range" 
                          min="0.05" 
                          max="1.0" 
                          step="0.05"
                          value={scale} 
                          onChange={(e) => setScale(Number(e.target.value))} 
                          className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                        />
                        <p className="text-xs text-gray-500 mt-1">
                          单帧尺寸: {Math.round(videoMeta.width * scale)} x {Math.round(videoMeta.height * scale)} px
                        </p>
                      </div>

                      {/* 列数滑块 */}
                      <div>
                        <div className="flex justify-between mb-2">
                          <label className="text-sm text-gray-300">每行列数 (Columns)</label>
                          <span className="text-sm font-mono text-indigo-400">{columns}</span>
                        </div>
                        <input 
                          type="range" 
                          min="1" 
                          max={frameCount} // 允许最大列数等于帧数，排成一行
                          step="1"
                          value={columns} 
                          onChange={(e) => setColumns(Number(e.target.value))} 
                          className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                        />
                      </div>

                      {/* 信息概览与警告 */}
                      {videoUrl && (
                        <div className={`p-3 rounded text-xs space-y-1 border ${isSizeWarning ? 'bg-red-900/20 border-red-500/50 text-red-200' : 'bg-gray-900 border-transparent text-gray-400'}`}>
                          <div className="flex justify-between">
                            <span>原视频时长:</span>
                            <span>{formatTime(videoMeta.duration)}</span>
                          </div>
                          <div className="flex justify-between pt-1">
                            <span>预计输出大小:</span>
                            <span className={isSizeWarning ? 'font-bold' : ''}>
                              {estimatedW} x {estimatedH} px
                            </span>
                          </div>
                          {isSizeWarning && (
                              <div className="flex items-start gap-1 mt-2 text-red-300">
                                  <AlertCircleIcon className="w-3 h-3 mt-0.5 shrink-0" />
                                  <span>尺寸过大，可能导致崩溃！请减小帧数或缩放。</span>
                              </div>
                          )}
                        </div>
                      )}

                      <button 
                        onClick={generateSprite}
                        disabled={!videoUrl || isProcessing}
                        className={`w-full py-3 px-4 rounded-lg font-bold text-white transition-all flex items-center justify-center space-x-2
                          ${!videoUrl 
                            ? 'bg-gray-700 cursor-not-allowed text-gray-500' 
                            : isProcessing 
                              ? 'bg-indigo-700 cursor-wait opacity-80' 
                              : 'bg-indigo-600 hover:bg-indigo-500 hover:shadow-lg hover:shadow-indigo-500/25 active:transform active:scale-95'
                          }`}
                      >
                        {isProcessing ? (
                          <>
                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                            <span>处理中 {progress}%...</span>
                          </>
                        ) : (
                          <>
                            <ImageIcon className="w-5 h-5" />
                            <span>生成精灵图</span>
                          </>
                        )}
                      </button>
                    </div>
                  </div>

                  {/* 预览区域 */}
                  <div className="lg:col-span-2 bg-gray-800 rounded-xl border border-gray-700 p-1 overflow-hidden flex flex-col h-[600px] lg:h-auto">
                     <div className="bg-gray-900 border-b border-gray-700 p-3 flex justify-between items-center">
                        <h2 className="text-sm font-medium text-gray-300">预览结果</h2>
                        {generatedImage && (
                          <button 
                            onClick={downloadImage}
                            className="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-1.5 rounded flex items-center space-x-1 transition-colors"
                          >
                            <DownloadIcon className="w-3 h-3" />
                            <span>下载 PNG</span>
                          </button>
                        )}
                     </div>

                     <div className="flex-1 overflow-auto bg-gray-900/50 p-4 relative flex items-center justify-center custom-scrollbar">
                        <canvas ref={canvasRef} className="hidden" />

                        {error && (
                          <div className="text-red-400 flex flex-col items-center text-center max-w-md p-4 bg-red-900/20 rounded-lg border border-red-500/30">
                            <AlertCircleIcon className="w-8 h-8 mb-2" />
                            <p className="font-medium">出错了</p>
                            <p className="text-sm opacity-80 mt-1">{error}</p>
                          </div>
                        )}

                        {!generatedImage && !isProcessing && !error && (
                           <div className="text-gray-600 flex flex-col items-center">
                              <div className="w-16 h-16 border-2 border-dashed border-gray-700 rounded-lg mb-2 flex items-center justify-center">
                                <ImageIcon className="w-6 h-6" />
                              </div>
                              <p className="text-sm">预览将显示在这里</p>
                           </div>
                        )}

                        {isProcessing && (
                          <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/80 z-10 backdrop-blur-sm">
                             <div className="w-64 h-4 bg-gray-700 rounded-full overflow-hidden mb-2">
                                <div 
                                  className="h-full bg-indigo-500 transition-all duration-300 ease-out"
                                  style={{ width: `${progress}%` }}
                                ></div>
                             </div>
                             <p className="text-indigo-300 text-sm font-mono animate-pulse">正在提取帧: {progress}%</p>
                          </div>
                        )}
                        
                        {generatedImage && (
                          <img 
                            src={generatedImage} 
                            alt="Generated Sprite Sheet" 
                            className="max-w-none shadow-2xl border border-gray-700"
                          />
                        )}
                     </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
