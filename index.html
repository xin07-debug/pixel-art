import React, { useState, useRef, useEffect } from 'react';
import { Upload, Image as ImageIcon, Download, Settings, Film, AlertCircle } from 'lucide-react';

const App = () => {
  const [videoUrl, setVideoUrl] = useState(null);
  const [videoMeta, setVideoMeta] = useState({ duration: 0, width: 0, height: 0 });
  const [frameCount, setFrameCount] = useState(12);
  const [scale, setScale] = useState(0.25); // Default 25% scale
  const [columns, setColumns] = useState(4);
  const [isProcessing, setIsProcessing] = useState(false);
  const [progress, setProgress] = useState(0);
  const [generatedImage, setGeneratedImage] = useState(null);
  const [error, setError] = useState(null);

  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const fileInputRef = useRef(null);

  // 当帧数改变时，自动调整列数为大致的平方根，保持矩形比例
  useEffect(() => {
    if (frameCount > 0) {
      setColumns(Math.ceil(Math.sqrt(frameCount)));
    }
  }, [frameCount]);

  const handleFileChange = (event) => {
    const file = event.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      setVideoUrl(url);
      setGeneratedImage(null);
      setError(null);
      setProgress(0);
    }
  };

  const handleLoadedMetadata = () => {
    if (videoRef.current) {
      setVideoMeta({
        duration: videoRef.current.duration,
        width: videoRef.current.videoWidth,
        height: videoRef.current.videoHeight,
      });
    }
  };

  const seekToTime = (videoElement, time) => {
    return new Promise((resolve) => {
      const onSeeked = () => {
        videoElement.removeEventListener('seeked', onSeeked);
        resolve();
      };
      videoElement.addEventListener('seeked', onSeeked);
      videoElement.currentTime = time;
    });
  };

  const generateSprite = async () => {
    if (!videoRef.current || !canvasRef.current) return;

    setIsProcessing(true);
    setProgress(0);
    setError(null);
    setGeneratedImage(null);

    try {
      const video = videoRef.current;
      const canvas = canvasRef.current;
      const ctx = canvas.getContext('2d');

      const totalFrames = parseInt(frameCount);
      const cols = parseInt(columns);
      const rows = Math.ceil(totalFrames / cols);

      // 计算单帧尺寸
      const frameWidth = videoMeta.width * scale;
      const frameHeight = videoMeta.height * scale;

      // 设置画布总尺寸
      canvas.width = cols * frameWidth;
      canvas.height = rows * frameHeight;

      // 清空画布
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // 计算时间间隔
      const interval = videoMeta.duration / (totalFrames + 1); // +1 避免取到最后一帧如果是黑屏

      for (let i = 0; i < totalFrames; i++) {
        // 更新进度
        setProgress(Math.round(((i + 1) / totalFrames) * 100));

        // 跳转视频时间
        const time = interval * (i + 1); // 从第一段时间开始，不取0秒
        await seekToTime(video, time);

        // 计算当前帧在画布上的位置
        const x = (i % cols) * frameWidth;
        const y = Math.floor(i / cols) * frameHeight;

        // 绘制当前帧
        ctx.drawImage(video, 0, 0, videoMeta.width, videoMeta.height, x, y, frameWidth, frameHeight);
      }

      // 导出图片
      const dataUrl = canvas.toDataURL('image/png');
      setGeneratedImage(dataUrl);

    } catch (err) {
      console.error(err);
      setError("生成过程中发生错误，请尝试减少帧数或降低缩放比例。");
    } finally {
      setIsProcessing(false);
    }
  };

  const downloadImage = () => {
    if (generatedImage) {
      const link = document.createElement('a');
      link.href = generatedImage;
      link.download = `sprite-sheet-${Date.now()}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  };

  const formatTime = (seconds) => {
    if (!seconds) return "0:00";
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  };

  return (
    <div className="min-h-screen bg-gray-900 text-gray-100 font-sans p-4 md:p-8">
      <div className="max-w-6xl mx-auto space-y-8">
        
        {/* Header */}
        <header className="flex flex-col md:flex-row items-center justify-between border-b border-gray-800 pb-6">
          <div className="flex items-center space-x-3 mb-4 md:mb-0">
            <div className="p-3 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-500/20">
              <Film className="w-8 h-8 text-white" />
            </div>
            <div>
              <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
                视频精灵图生成器
              </h1>
              <p className="text-gray-400 text-sm">自动提取视频帧并合并为一张大图</p>
            </div>
          </div>
        </header>

        {/* Main Content Grid */}
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* Left Panel: Controls */}
          <div className="lg:col-span-1 space-y-6">
            
            {/* Upload Area */}
            <div 
              className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors cursor-pointer group ${videoUrl ? 'border-green-500/50 bg-green-500/5' : 'border-gray-700 hover:border-indigo-500 hover:bg-gray-800'}`}
              onClick={() => fileInputRef.current.click()}
            >
              <input 
                type="file" 
                ref={fileInputRef} 
                accept="video/*" 
                className="hidden" 
                onChange={handleFileChange} 
              />
              {videoUrl ? (
                 <div className="flex flex-col items-center text-green-400">
                    <Film className="w-10 h-10 mb-2" />
                    <span className="font-medium">视频已加载</span>
                    <span className="text-xs text-gray-400 mt-1">点击更换视频</span>
                 </div>
              ) : (
                <div className="flex flex-col items-center text-gray-400 group-hover:text-indigo-400">
                  <Upload className="w-10 h-10 mb-2" />
                  <span className="font-medium">点击上传视频</span>
                  <span className="text-xs text-gray-500 mt-1">支持 MP4, WebM, MOV</span>
                </div>
              )}
            </div>

            {/* Video Info (Hidden Player) */}
            <video 
              ref={videoRef} 
              src={videoUrl} 
              onLoadedMetadata={handleLoadedMetadata} 
              className="hidden" 
              crossOrigin="anonymous"
              muted
            />

            {/* Settings */}
            <div className="bg-gray-800 rounded-xl p-6 border border-gray-700 space-y-6">
              <div className="flex items-center space-x-2 text-lg font-semibold text-white mb-2">
                <Settings className="w-5 h-5 text-indigo-400" />
                <span>生成设置</span>
              </div>

              {/* Frame Count */}
              <div>
                <div className="flex justify-between mb-2">
                  <label className="text-sm text-gray-300">提取帧数 (Frames)</label>
                  <span className="text-sm font-mono text-indigo-400">{frameCount}</span>
                </div>
                <input 
                  type="range" 
                  min="4" 
                  max="100" 
                  step="1"
                  value={frameCount} 
                  onChange={(e) => setFrameCount(Number(e.target.value))} 
                  className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                />
              </div>

              {/* Scale */}
              <div>
                <div className="flex justify-between mb-2">
                  <label className="text-sm text-gray-300">图片缩放 (Scale)</label>
                  <span className="text-sm font-mono text-indigo-400">{Math.round(scale * 100)}%</span>
                </div>
                <input 
                  type="range" 
                  min="0.1" 
                  max="1.0" 
                  step="0.05"
                  value={scale} 
                  onChange={(e) => setScale(Number(e.target.value))} 
                  className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                />
                <p className="text-xs text-gray-500 mt-1">
                  单帧尺寸: {Math.round(videoMeta.width * scale)} x {Math.round(videoMeta.height * scale)} px
                </p>
              </div>

              {/* Columns */}
              <div>
                <div className="flex justify-between mb-2">
                  <label className="text-sm text-gray-300">每行列数 (Columns)</label>
                  <span className="text-sm font-mono text-indigo-400">{columns}</span>
                </div>
                <input 
                  type="range" 
                  min="1" 
                  max={Math.min(frameCount, 20)} 
                  step="1"
                  value={columns} 
                  onChange={(e) => setColumns(Number(e.target.value))} 
                  className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                />
              </div>

              {/* Info Summary */}
              {videoUrl && (
                <div className="p-3 bg-gray-900 rounded text-xs text-gray-400 space-y-1">
                  <div className="flex justify-between">
                    <span>原视频时长:</span>
                    <span>{formatTime(videoMeta.duration)}</span>
                  </div>
                  <div className="flex justify-between">
                    <span>原分辨率:</span>
                    <span>{videoMeta.width} x {videoMeta.height}</span>
                  </div>
                  <div className="flex justify-between pt-2 border-t border-gray-800">
                    <span className="text-gray-300">预计输出大小:</span>
                    <span className="text-gray-300">
                      {Math.round(videoMeta.width * scale * columns)} x {Math.round(videoMeta.height * scale * Math.ceil(frameCount / columns))} px
                    </span>
                  </div>
                </div>
              )}

              {/* Action Button */}
              <button 
                onClick={generateSprite}
                disabled={!videoUrl || isProcessing}
                className={`w-full py-3 px-4 rounded-lg font-bold text-white transition-all flex items-center justify-center space-x-2
                  ${!videoUrl 
                    ? 'bg-gray-700 cursor-not-allowed text-gray-500' 
                    : isProcessing 
                      ? 'bg-indigo-700 cursor-wait opacity-80' 
                      : 'bg-indigo-600 hover:bg-indigo-500 hover:shadow-lg hover:shadow-indigo-500/25 active:transform active:scale-95'
                  }`}
              >
                {isProcessing ? (
                  <>
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                    <span>处理中 {progress}%...</span>
                  </>
                ) : (
                  <>
                    <ImageIcon className="w-5 h-5" />
                    <span>生成精灵图</span>
                  </>
                )}
              </button>
            </div>
          </div>

          {/* Right Panel: Preview */}
          <div className="lg:col-span-2 bg-gray-800 rounded-xl border border-gray-700 p-1 overflow-hidden flex flex-col h-[600px] lg:h-auto">
             <div className="bg-gray-900 border-b border-gray-700 p-3 flex justify-between items-center">
                <h2 className="text-sm font-medium text-gray-300">预览结果</h2>
                {generatedImage && (
                  <button 
                    onClick={downloadImage}
                    className="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-1.5 rounded flex items-center space-x-1 transition-colors"
                  >
                    <Download className="w-3 h-3" />
                    <span>下载 PNG</span>
                  </button>
                )}
             </div>

             <div className="flex-1 overflow-auto bg-gray-900/50 p-4 relative flex items-center justify-center custom-scrollbar">
                {/* Hidden Canvas used for processing */}
                <canvas ref={canvasRef} className="hidden" />

                {error && (
                  <div className="text-red-400 flex flex-col items-center">
                    <AlertCircle className="w-8 h-8 mb-2" />
                    <p>{error}</p>
                  </div>
                )}

                {!generatedImage && !isProcessing && !error && (
                   <div className="text-gray-600 flex flex-col items-center">
                      <div className="w-16 h-16 border-2 border-dashed border-gray-700 rounded-lg mb-2 flex items-center justify-center">
                        <ImageIcon className="w-6 h-6" />
                      </div>
                      <p className="text-sm">预览将显示在这里</p>
                   </div>
                )}

                {isProcessing && (
                  <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/80 z-10 backdrop-blur-sm">
                     <div className="w-64 h-4 bg-gray-700 rounded-full overflow-hidden mb-2">
                        <div 
                          className="h-full bg-indigo-500 transition-all duration-300 ease-out"
                          style={{ width: `${progress}%` }}
                        ></div>
                     </div>
                     <p className="text-indigo-300 text-sm font-mono animate-pulse">正在提取帧: {progress}%</p>
                  </div>
                )}
                
                {generatedImage && (
                  <img 
                    src={generatedImage} 
                    alt="Generated Sprite Sheet" 
                    className="max-w-none shadow-2xl border border-gray-700"
                  />
                )}
             </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default App;
