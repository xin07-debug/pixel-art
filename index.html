<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘è½¬ GIF/ç²¾çµå›¾å·¥å…· (æ”¯æŒé€æ˜/æŠ å›¾/é€å¸§ç²¾ä¿®)</title>
    <!-- å¼•å…¥ Tailwind CSS (æ ·å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ React å’Œ ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- å¼•å…¥ Babel (è®©æµè§ˆå™¨èƒ½è¿è¡Œ React ä»£ç ) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- å¼•å…¥ gif.js (æ ¸å¿ƒåº“) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    
    <style>
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* éšè—è§†é¢‘ä½†ä¿æŒæ¸²æŸ“ */
        .video-hidden { 
            position: absolute;
            top: -9999px;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
            width: 320px; 
            height: 240px;
        }
        
        /* é¢œè‰²é€‰æ‹©å™¨æ ·å¼ä¼˜åŒ– */
        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 32px;
            height: 32px;
            padding: 0;
            overflow: hidden;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 2px solid #4b5563;
            border-radius: 50%;
        }

        /* ä¿®å¤æ¨¡å¼ä¸‹çš„å…‰æ ‡ */
        .cursor-crosshair-custom {
            cursor: crosshair;
        }
        
        /* æ£‹ç›˜æ ¼èƒŒæ™¯ */
        .bg-checkerboard {
            background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMUlEQVQ4T2NkYGAQYcAP3uCTZhw1gGGYhAGBZIA/nYDCgBDAm9BGDWCEAvgUGjZGYwIAxuoHr4hHvAQAAAAASUVORK5CYII=');
            background-repeat: repeat;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        // å›¾æ ‡ç»„ä»¶
        const FilmIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>;
        const UploadIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const ImageIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;
        const DownloadIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const AlertCircleIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const WandIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 4V2"/><path d="M15 16v-2"/><path d="M8 9h2"/><path d="M20 9h2"/><path d="M17.8 11.8 19 13"/><path d="M15 9h0"/><path d="M17.8 6.2 19 5"/><path d="m3 21 9-9"/><path d="M12.2 6.2 11 5"/></svg>;
        const GridIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>;
        const ShieldIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>;
        const RepairIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>;
        const TrashIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const SettingsIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const ZoomInIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" x2="16.65" y1="21" y2="16.65"/><line x1="11" x2="11" y1="8" y2="14"/><line x1="8" x2="14" y1="11" y2="11"/></svg>;
        const CloseIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const ChevronLeftIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"/></svg>;
        const ChevronRightIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>;

        const App = () => {
          const [videoUrl, setVideoUrl] = useState(null);
          const [videoMeta, setVideoMeta] = useState({ duration: 0, width: 0, height: 0 });
          
          // é…ç½®å‚æ•°
          const [outputMode, setOutputMode] = useState('sprite');
          const [frameCount, setFrameCount] = useState(12);
          const [scale, setScale] = useState(0.25);
          const [columns, setColumns] = useState(4);
          
          // æŠ å›¾å‚æ•°
          const [removeBg, setRemoveBg] = useState(false);
          const [keyColor, setKeyColor] = useState('#00ff00');
          const [enableSecondColor, setEnableSecondColor] = useState(false);
          const [keyColor2, setKeyColor2] = useState('#cccccc');
          const [tolerance, setTolerance] = useState(60);
          const [protectBody, setProtectBody] = useState(false);
          
          // æ‰‹åŠ¨ä¿®è¡¥å‚æ•°
          const [manualSeeds, setManualSeeds] = useState([]); // {x, y} normalized
          const [showFrameInspector, setShowFrameInspector] = useState(false);
          const [currentInspectFrame, setCurrentInspectFrame] = useState(0);

          // ç¼“å­˜åŸå§‹å¸§æ•°æ® (ImageBitmap)
          const rawFramesRef = useRef([]);

          // çŠ¶æ€
          const [isProcessing, setIsProcessing] = useState(false);
          const [progress, setProgress] = useState(0);
          const [generatedImage, setGeneratedImage] = useState(null);
          const [error, setError] = useState(null);

          const videoRef = useRef(null);
          const canvasRef = useRef(null);
          const inspectorCanvasRef = useRef(null);
          const fileInputRef = useRef(null);

          useEffect(() => {
            if (frameCount > 0 && outputMode === 'sprite') {
              setColumns(Math.ceil(Math.sqrt(frameCount)));
            }
          }, [frameCount, outputMode]);

          const handleFileChange = (event) => {
            const file = event.target.files[0];
            if (file) {
              if (videoUrl) URL.revokeObjectURL(videoUrl);
              const url = URL.createObjectURL(file);
              setVideoUrl(url);
              setGeneratedImage(null);
              setError(null);
              setProgress(0);
              setManualSeeds([]);
              rawFramesRef.current = []; // æ¸…ç©ºç¼“å­˜
            }
          };

          const handleLoadedMetadata = () => {
            if (videoRef.current) {
              setVideoMeta({
                duration: videoRef.current.duration,
                width: videoRef.current.videoWidth,
                height: videoRef.current.videoHeight,
              });
            }
          };

          const hexToRgb = (hex) => {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
              r: parseInt(result[1], 16),
              g: parseInt(result[2], 16),
              b: parseInt(result[3], 16)
            } : null;
          };

          // æ ¸å¿ƒæŠ å›¾ç®—æ³•
          const applyChromaKey = (ctx, width, height, colors, tolerance, protectBody, extraSeeds = []) => {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            const targets = colors.map(c => hexToRgb(c)).filter(Boolean);
            if (targets.length === 0) return;

            const toleranceSq = tolerance * tolerance;
            const isMatch = (r, g, b) => {
                for (let t of targets) {
                    if ((r - t.r) ** 2 + (g - t.g) ** 2 + (b - t.b) ** 2 < toleranceSq) return true;
                }
                return false;
            };

            if (!protectBody && extraSeeds.length === 0) {
                // å…¨å±€æ›¿æ¢
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i+3] === 0) continue;
                    if (isMatch(data[i], data[i+1], data[i+2])) {
                        data[i + 3] = 0; 
                    }
                }
            } else {
                // æ³›æ´ªå¡«å……
                const stack = []; 
                const visited = new Uint8Array(width * height); // è¾…åŠ©æ•°ç»„é¿å…é‡å¤å…¥æ ˆï¼Œæå‡æ€§èƒ½
                const getIdx = (x, y) => (y * width + x);

                const checkAndPush = (x, y) => {
                    if (x < 0 || x >= width || y < 0 || y >= height) return;
                    const vIdx = getIdx(x, y);
                    if (visited[vIdx]) return;
                    
                    const idx = vIdx * 4;
                    // åªæœ‰æœªå¤„ç†è¿‡(éé€æ˜)ä¸”åŒ¹é…é¢œè‰²çš„æ‰åŠ å…¥
                    if (data[idx+3] !== 0 && isMatch(data[idx], data[idx+1], data[idx+2])) {
                        stack.push([x, y]);
                        data[idx+3] = 0; 
                        visited[vIdx] = 1;
                    }
                };

                // 1. è¾¹ç¼˜ç§å­
                if (protectBody) {
                    for (let x = 0; x < width; x++) { checkAndPush(x, 0); checkAndPush(x, height - 1); }
                    for (let y = 1; y < height - 1; y++) { checkAndPush(0, y); checkAndPush(width - 1, y); }
                }

                // 2. æ‰‹åŠ¨ç§å­
                for (let seed of extraSeeds) {
                    const sx = Math.floor(seed.x * width);
                    const sy = Math.floor(seed.y * height);
                    for(let dx = -1; dx <= 1; dx++) {
                        for(let dy = -1; dy <= 1; dy++) { checkAndPush(sx + dx, sy + dy); }
                    }
                }

                // 3. BFS
                while (stack.length > 0) {
                    const [cx, cy] = stack.pop();
                    checkAndPush(cx + 1, cy);
                    checkAndPush(cx - 1, cy);
                    checkAndPush(cx, cy + 1);
                    checkAndPush(cx, cy - 1);
                }
            }
            ctx.putImageData(imageData, 0, 0);
          };

          const seekToTime = (videoElement, time) => {
            return new Promise((resolve) => {
              const timeoutId = setTimeout(() => resolve(), 3000);
              const onSeeked = () => {
                clearTimeout(timeoutId);
                videoElement.removeEventListener('seeked', onSeeked);
                requestAnimationFrame(() => requestAnimationFrame(() => resolve()));
              };
              videoElement.addEventListener('seeked', onSeeked);
              videoElement.currentTime = time;
            });
          };

          const applyCheckerboardPreset = () => {
              setKeyColor('#ffffff'); setKeyColor2('#cccccc'); 
              setEnableSecondColor(true); setTolerance(50); 
              setRemoveBg(true); setProtectBody(true);
          };

          // æ ¸å¿ƒç”Ÿæˆé€»è¾‘
          const generate = async () => {
            if (!videoRef.current || !canvasRef.current) return;
            setIsProcessing(true); setProgress(0); setError(null); setGeneratedImage(null);
            
            // æ¸…ç©ºæ—§ç¼“å­˜
            rawFramesRef.current = [];

            try {
              const video = videoRef.current;
              const canvas = canvasRef.current;
              const ctx = canvas.getContext('2d', { willReadFrequently: true });

              const totalFrames = parseInt(frameCount);
              const frameWidth = Math.floor(videoMeta.width * scale);
              const frameHeight = Math.floor(videoMeta.height * scale);

              let gif = null;
              if (outputMode === 'gif') {
                  try {
                      const workerBlob = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js').then(r => r.blob());
                      gif = new GIF({ workers: 2, quality: 10, width: frameWidth, height: frameHeight, workerScript: URL.createObjectURL(workerBlob) });
                  } catch (e) { throw new Error("GIFåº“åˆå§‹åŒ–å¤±è´¥"); }
              }

              // Canvaså°ºå¯¸
              let cols = 1, rows = 1;
              if (outputMode === 'sprite') {
                  cols = parseInt(columns);
                  rows = Math.ceil(totalFrames / cols);
                  canvas.width = cols * frameWidth; canvas.height = rows * frameHeight;
              } else {
                  canvas.width = frameWidth; canvas.height = frameHeight;
              }
              ctx.clearRect(0, 0, canvas.width, canvas.height);
              
              const interval = videoMeta.duration / (totalFrames + 1);
              const delay = interval * 1000;

              const tempCanvas = document.createElement('canvas');
              tempCanvas.width = frameWidth; tempCanvas.height = frameHeight;
              const tempCtx = tempCanvas.getContext('2d', { willReadFrequently: true });

              const colorsToRemove = [];
              if (removeBg) {
                  colorsToRemove.push(keyColor);
                  if (enableSecondColor) colorsToRemove.push(keyColor2);
              }

              for (let i = 0; i < totalFrames; i++) {
                if (!videoRef.current) break;
                const time = interval * (i + 1);
                await seekToTime(video, time);

                tempCtx.clearRect(0, 0, frameWidth, frameHeight);
                if (video.readyState >= 2) {
                    tempCtx.drawImage(video, 0, 0, videoMeta.width, videoMeta.height, 0, 0, frameWidth, frameHeight);
                    // ç¼“å­˜åŸå§‹å¸§ (ImageBitmap æ€§èƒ½æ›´å¥½ï¼Œä½†éœ€è¦å¼‚æ­¥ï¼Œè¿™é‡Œç®€å•ç”¨ ImageData æˆ– Canvas)
                    // ä¸ºäº†åç»­å¤„ç†æ–¹ä¾¿ï¼Œè¿™é‡Œç›´æ¥æ·±æ‹·è´ ImageData
                    const rawData = tempCtx.getImageData(0, 0, frameWidth, frameHeight);
                    rawFramesRef.current.push(rawData);
                }

                if (removeBg) {
                    applyChromaKey(tempCtx, frameWidth, frameHeight, colorsToRemove, tolerance, protectBody, manualSeeds);
                }

                let dx = 0, dy = 0;
                if (outputMode === 'sprite') {
                    dx = (i % cols) * frameWidth; dy = Math.floor(i / cols) * frameHeight;
                } else {
                    ctx.clearRect(0, 0, frameWidth, frameHeight);
                }

                ctx.drawImage(tempCanvas, 0, 0, frameWidth, frameHeight, dx, dy, frameWidth, frameHeight);
                if (gif) gif.addFrame(ctx, { copy: true, delay: delay, dispose: 2 });
                setProgress(Math.round(((i + 1) / totalFrames) * 90)); 
              }

              if (outputMode === 'sprite') {
                  setGeneratedImage(canvas.toDataURL('image/png'));
                  setProgress(100);
              } else if (gif) {
                  setProgress(95);
                  gif.on('finished', blob => { setGeneratedImage(URL.createObjectURL(blob)); setProgress(100); });
                  gif.render();
              }
            } catch (err) {
              console.error(err); setError(err.message || "ç”Ÿæˆå¤±è´¥");
            } finally {
              if (outputMode === 'sprite') setIsProcessing(false);
            }
          };

          // --- é€å¸§ç²¾ä¿®é€»è¾‘ ---
          
          const openInspector = () => {
              if (rawFramesRef.current.length === 0) {
                  alert("è¯·å…ˆç‚¹å‡»ç”Ÿæˆçš„ç²¾çµå›¾æˆ–GIFï¼Œç¡®ä¿ç¼“å­˜å·²å»ºç«‹ã€‚");
                  return;
              }
              setShowFrameInspector(true);
              setCurrentInspectFrame(0);
          };

          // æ¸²æŸ“ Inspector çš„å½“å‰å¸§
          useEffect(() => {
              if (!showFrameInspector || !inspectorCanvasRef.current) return;
              const rawData = rawFramesRef.current[currentInspectFrame];
              if (!rawData) return;

              const canvas = inspectorCanvasRef.current;
              const ctx = canvas.getContext('2d', { willReadFrequently: true });
              
              canvas.width = rawData.width;
              canvas.height = rawData.height;

              // 1. è¿˜åŸåŸå§‹å¸§
              ctx.putImageData(rawData, 0, 0);

              // 2. åº”ç”¨å½“å‰çš„æŠ å›¾è®¾ç½®
              if (removeBg) {
                  const colorsToRemove = [keyColor];
                  if (enableSecondColor) colorsToRemove.push(keyColor2);
                  applyChromaKey(ctx, canvas.width, canvas.height, colorsToRemove, tolerance, protectBody, manualSeeds);
              }
          }, [showFrameInspector, currentInspectFrame, removeBg, keyColor, keyColor2, tolerance, protectBody, manualSeeds]);


          const handleInspectorClick = (e) => {
              const canvas = inspectorCanvasRef.current;
              const rect = canvas.getBoundingClientRect();
              const scaleX = canvas.width / rect.width;
              const scaleY = canvas.height / rect.height;
              const x = (e.clientX - rect.left) * scaleX;
              const y = (e.clientY - rect.top) * scaleY;
              
              const seed = { x: x / canvas.width, y: y / canvas.height };
              setManualSeeds(prev => [...prev, seed]);
          };

          // å…³é—­ Inspector æ—¶ï¼Œé‡æ–°ç”Ÿæˆæœ€ç»ˆç»“æœ
          const closeInspector = () => {
              setShowFrameInspector(false);
              // å¦‚æœæœ‰ä¿®è¡¥ç‚¹ï¼Œè§¦å‘é‡æ–°ç”Ÿæˆä»¥åº”ç”¨åˆ°æœ€ç»ˆçš„å¤§å›¾/GIF
              if (manualSeeds.length > 0) {
                  generate();
              }
          };

          const downloadImage = () => {
            if (generatedImage) {
              const link = document.createElement('a');
              link.href = generatedImage;
              link.download = outputMode === 'sprite' ? `sprite-${Date.now()}.png` : `animation-${Date.now()}.gif`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }
          };
          
          const formatTime = (seconds) => {
            if (!seconds) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
          };

          const estimatedW = Math.round(videoMeta.width * scale * (outputMode === 'sprite' ? columns : 1));
          const estimatedH = Math.round(videoMeta.height * scale * (outputMode === 'sprite' ? Math.ceil(frameCount / columns) : 1));

          return (
            <div className="min-h-screen bg-gray-900 text-gray-100 font-sans p-4 md:p-8">
              <div className="max-w-6xl mx-auto space-y-8">
                
                <header className="flex flex-col md:flex-row items-center justify-between border-b border-gray-800 pb-6">
                  <div className="flex items-center space-x-3 mb-4 md:mb-0">
                    <div className="p-3 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-500/20">
                      <FilmIcon className="w-8 h-8 text-white" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
                        è§†é¢‘è½¬ GIF/ç²¾çµå›¾
                      </h1>
                      <p className="text-gray-400 text-sm">æ”¯æŒé€æ˜èƒŒæ™¯è§†é¢‘ï¼Œä¸€é”®ç”Ÿæˆ GIF æˆ– Sprite</p>
                    </div>
                  </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  
                  <div className="lg:col-span-1 space-y-6">
                    
                    <div 
                      className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors cursor-pointer group ${videoUrl ? 'border-green-500/50 bg-green-500/5' : 'border-gray-700 hover:border-indigo-500 hover:bg-gray-800'}`}
                      onClick={() => fileInputRef.current.click()}
                    >
                      <input type="file" ref={fileInputRef} accept="video/*" className="hidden" onChange={handleFileChange} />
                      {videoUrl ? (
                         <div className="flex flex-col items-center text-green-400">
                            <FilmIcon className="w-10 h-10 mb-2" />
                            <span className="font-medium">è§†é¢‘å·²åŠ è½½</span>
                            <span className="text-xs text-gray-400 mt-1">ç‚¹å‡»æ›´æ¢è§†é¢‘</span>
                         </div>
                      ) : (
                        <div className="flex flex-col items-center text-gray-400 group-hover:text-indigo-400">
                          <UploadIcon className="w-10 h-10 mb-2" />
                          <span className="font-medium">ç‚¹å‡»ä¸Šä¼ è§†é¢‘</span>
                          <span className="text-xs text-gray-500 mt-1">æ”¯æŒ MP4, WebM, MOV</span>
                        </div>
                      )}
                    </div>

                    <video ref={videoRef} src={videoUrl} onLoadedMetadata={handleLoadedMetadata} className="video-hidden" muted playsInline preload="auto" />

                    <div className="bg-gray-800 rounded-xl p-6 border border-gray-700 space-y-6">
                      <div className="flex items-center space-x-2 text-lg font-semibold text-white mb-2">
                        <SettingsIcon className="w-5 h-5 text-indigo-400" />
                        <span>ç”Ÿæˆè®¾ç½®</span>
                      </div>

                      <div className="bg-gray-900 p-1 rounded-lg flex space-x-1">
                          <button onClick={() => setOutputMode('sprite')} className={`flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all ${outputMode === 'sprite' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}>PNG ç²¾çµå›¾</button>
                          <button onClick={() => setOutputMode('gif')} className={`flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all ${outputMode === 'gif' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}>GIF åŠ¨å›¾</button>
                      </div>

                      <div className="space-y-4">
                        <div>
                            <div className="flex justify-between mb-2">
                              <label className="text-sm text-gray-300">æå–å¸§æ•°</label>
                              <span className="text-sm font-mono text-indigo-400">{frameCount}</span>
                            </div>
                            <input type="range" min="1" max="300" step="1" value={frameCount} onChange={(e) => setFrameCount(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" />
                        </div>
                        <div>
                            <div className="flex justify-between mb-2">
                              <label className="text-sm text-gray-300">å›¾ç‰‡ç¼©æ”¾</label>
                              <span className="text-sm font-mono text-indigo-400">{Math.round(scale * 100)}%</span>
                            </div>
                            <input type="range" min="0.05" max="1.0" step="0.05" value={scale} onChange={(e) => setScale(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" />
                        </div>
                        {outputMode === 'sprite' && (
                          <div>
                            <div className="flex justify-between mb-2">
                              <label className="text-sm text-gray-300">æ¯è¡Œåˆ—æ•°</label>
                              <span className="text-sm font-mono text-indigo-400">{columns}</span>
                            </div>
                            <input type="range" min="1" max={frameCount} step="1" value={columns} onChange={(e) => setColumns(Number(e.target.value))} className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" />
                          </div>
                        )}
                      </div>

                      <div className="pt-4 border-t border-gray-700">
                          <button onClick={() => setRemoveBg(!removeBg)} className="flex items-center space-x-2 text-sm font-medium text-gray-300 hover:text-white transition-colors mb-4 w-full">
                             <div className={`w-4 h-4 rounded border ${removeBg ? 'bg-indigo-500 border-indigo-500' : 'border-gray-500'} flex items-center justify-center`}>
                                {removeBg && <svg className="w-3 h-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>}
                             </div>
                             <span className="flex items-center"><WandIcon className="w-4 h-4 mr-1.5" />å¯ç”¨èƒŒæ™¯ç§»é™¤ (æŠ å›¾)</span>
                          </button>

                          {removeBg && (
                              <div className="space-y-4 bg-gray-900/50 p-4 rounded-lg border border-gray-700 animate-in fade-in slide-in-from-top-2 duration-200">
                                  <button onClick={applyCheckerboardPreset} className="w-full py-2 bg-gray-700 hover:bg-gray-600 text-xs text-white rounded flex items-center justify-center space-x-2 border border-gray-600 mb-2 transition-colors">
                                      <GridIcon className="w-3 h-3 text-gray-300" /><span>ä¸€é”®åº”ç”¨ï¼šå»é™¤ç°ç™½æ£‹ç›˜æ ¼</span>
                                  </button>
                                  <div className="flex items-center justify-between">
                                      <label className="text-xs text-gray-400">ä¸»è¦é¢œè‰²</label>
                                      <div className="flex items-center space-x-2">
                                          <span className="text-xs font-mono text-gray-500">{keyColor}</span>
                                          <input type="color" value={keyColor} onChange={(e) => setKeyColor(e.target.value)} className="border-0 p-0 rounded-full w-8 h-8 cursor-pointer ring-2 ring-gray-700 hover:ring-indigo-500 transition-all" />
                                      </div>
                                  </div>
                                  <div className="flex items-center justify-between pt-2 border-t border-gray-800">
                                      <div className="flex items-center space-x-2">
                                          <input type="checkbox" id="enableSecond" checked={enableSecondColor} onChange={(e) => setEnableSecondColor(e.target.checked)} className="rounded border-gray-600 bg-gray-700 text-indigo-500 focus:ring-indigo-500" />
                                          <label htmlFor="enableSecond" className="text-xs text-gray-400 select-none cursor-pointer">å¯ç”¨ç¬¬äºŒç§é¢œè‰²</label>
                                      </div>
                                      {enableSecondColor && (
                                          <div className="flex items-center space-x-2">
                                              <span className="text-xs font-mono text-gray-500">{keyColor2}</span>
                                              <input type="color" value={keyColor2} onChange={(e) => setKeyColor2(e.target.value)} className="border-0 p-0 rounded-full w-8 h-8 cursor-pointer ring-2 ring-gray-700 hover:ring-indigo-500 transition-all" />
                                          </div>
                                      )}
                                  </div>
                                  <div>
                                      <div className="flex justify-between mb-1">
                                        <label className="text-xs text-gray-400">é¢œè‰²å®¹å·®</label>
                                        <span className="text-xs font-mono text-indigo-400">{tolerance}</span>
                                      </div>
                                      <input type="range" min="1" max="440" step="1" value={tolerance} onChange={(e) => setTolerance(Number(e.target.value))} className="w-full h-1.5 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500" />
                                  </div>
                                  <div className="pt-2 border-t border-gray-800">
                                      <div className="flex items-center justify-between">
                                          <div className="flex items-center space-x-2 text-gray-300">
                                            <ShieldIcon className="w-4 h-4 text-green-400" />
                                            <span className="text-xs font-medium">åªç§»é™¤è¾¹ç¼˜èƒŒæ™¯ (ä¿æŠ¤äººç‰©)</span>
                                          </div>
                                          <div className={`w-10 h-5 flex items-center bg-gray-700 rounded-full p-1 cursor-pointer transition-colors ${protectBody ? 'bg-green-600' : ''}`} onClick={() => setProtectBody(!protectBody)}>
                                            <div className={`bg-white w-3 h-3 rounded-full shadow-md transform transition-transform ${protectBody ? 'translate-x-5' : ''}`}></div>
                                          </div>
                                      </div>
                                      <p className="text-[10px] text-gray-500 mt-1 pl-6">å¼€å¯åï¼Œä»…ç§»é™¤ä¸è¾¹ç¼˜è¿é€šçš„èƒŒæ™¯ã€‚å¦‚æœè£¤ç¼æ˜¯å°é—­çš„ï¼Œä¼šè¢«ä¿ç•™ã€‚</p>
                                  </div>
                              </div>
                          )}
                      </div>

                      {videoUrl && (
                        <div className="p-3 rounded text-xs space-y-1 bg-gray-900 border-transparent text-gray-400">
                          <div className="flex justify-between">
                            <span>åŸè§†é¢‘æ—¶é•¿:</span>
                            <span>{formatTime(videoMeta.duration)}</span>
                          </div>
                          <div className="flex justify-between pt-1">
                            <span>{outputMode === 'sprite' ? 'é¢„è®¡å¤§å›¾å°ºå¯¸' : 'GIF å°ºå¯¸'}:</span>
                            <span className="font-mono text-indigo-300">{estimatedW} x {estimatedH} px</span>
                          </div>
                        </div>
                      )}

                      <button onClick={generate} disabled={!videoUrl || isProcessing} className={`w-full py-3 px-4 rounded-lg font-bold text-white transition-all flex items-center justify-center space-x-2 ${!videoUrl ? 'bg-gray-700 cursor-not-allowed text-gray-500' : isProcessing ? 'bg-indigo-700 cursor-wait opacity-80' : 'bg-indigo-600 hover:bg-indigo-500 hover:shadow-lg hover:shadow-indigo-500/25 active:transform active:scale-95'}`}>
                        {isProcessing ? <><div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div><span>{progress < 100 ? `å¤„ç†ä¸­ ${progress}%` : 'æœ€ç»ˆæ¸²æŸ“ä¸­...'}</span></> : <><ImageIcon className="w-5 h-5" /><span>{outputMode === 'sprite' ? 'ç”Ÿæˆç²¾çµå›¾' : 'ç”Ÿæˆ GIF åŠ¨å›¾'}</span></>}
                      </button>
                    </div>
                  </div>

                  <div className="lg:col-span-2 flex flex-col h-full space-y-4">
                     {/* é¢„è§ˆç»“æœæ¡† */}
                     <div className="bg-gray-800 rounded-xl border border-gray-700 p-1 overflow-hidden flex flex-col flex-grow h-[500px] lg:h-auto">
                         <div className="bg-gray-900 border-b border-gray-700 p-3 flex justify-between items-center">
                            <h2 className="text-sm font-medium text-gray-300">é¢„è§ˆç»“æœ ({outputMode === 'sprite' ? 'PNG' : 'GIF'})</h2>
                            {generatedImage && (
                              <button onClick={downloadImage} className="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-1.5 rounded flex items-center space-x-1 transition-colors">
                                <DownloadIcon className="w-3 h-3" /><span>ä¸‹è½½ {outputMode === 'sprite' ? 'PNG' : 'GIF'}</span>
                              </button>
                            )}
                         </div>

                         <div className="flex-1 overflow-auto bg-gray-900/50 p-4 relative flex items-center justify-center custom-scrollbar">
                            <canvas ref={canvasRef} className="hidden" />

                            {error && (
                              <div className="text-red-400 flex flex-col items-center text-center max-w-md p-4 bg-red-900/20 rounded-lg border border-red-500/30">
                                <AlertCircleIcon className="w-8 h-8 mb-2" /><p className="font-medium">å‡ºé”™äº†</p><p className="text-sm opacity-80 mt-1">{error}</p>
                              </div>
                            )}

                            {!generatedImage && !isProcessing && !error && (
                               <div className="text-gray-600 flex flex-col items-center">
                                  <div className="w-16 h-16 border-2 border-dashed border-gray-700 rounded-lg mb-2 flex items-center justify-center"><ImageIcon className="w-6 h-6" /></div>
                                  <p className="text-sm">é¢„è§ˆå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
                               </div>
                            )}

                            {isProcessing && (
                              <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/80 z-10 backdrop-blur-sm pointer-events-none">
                                 <div className="w-64 h-4 bg-gray-700 rounded-full overflow-hidden mb-2">
                                    <div className="h-full bg-indigo-500 transition-all duration-300 ease-out" style={{ width: `${progress}%` }}></div>
                                 </div>
                                 <p className="text-indigo-300 text-sm font-mono animate-pulse">{outputMode === 'gif' && progress > 90 ? 'æ­£åœ¨ç¼–ç  GIF (å¯èƒ½éœ€è¦å‡ ç§’)...' : `æ­£åœ¨æå–å¸§: ${progress}%`}</p>
                              </div>
                            )}
                            
                            {generatedImage && (
                              <div className="relative group">
                                  <img src={generatedImage} alt="Generated Output" className="max-w-none shadow-2xl border border-gray-700 bg-checkerboard" />
                              </div>
                            )}
                         </div>
                     </div>
                     
                     {/* é€å¸§ç²¾ä¿®æŒ‰é’® (ä»…åœ¨ç”Ÿæˆåæ˜¾ç¤º) */}
                     {generatedImage && removeBg && protectBody && (
                         <div className="bg-gray-800 rounded-xl border border-gray-700 p-4 flex items-center justify-between">
                             <div className="flex flex-col">
                                <span className="text-sm font-bold text-white flex items-center"><RepairIcon className="w-4 h-4 mr-2 text-yellow-500"/>è¿˜ä¸å¤Ÿå¹²å‡€ï¼Ÿ</span>
                                <span className="text-xs text-gray-400">è¿›å…¥é€å¸§æ¨¡å¼ï¼Œåœ¨é™æ­¢ç”»é¢ä¸Šç‚¹å‡»æ¼æ‰çš„è‰²å—</span>
                             </div>
                             <button onClick={openInspector} className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white text-sm font-bold rounded-lg flex items-center space-x-2 transition-all shadow-lg shadow-yellow-500/10">
                                 <ZoomInIcon className="w-4 h-4"/>
                                 <span>è¿›å…¥é€å¸§ç²¾ä¿®</span>
                             </button>
                         </div>
                     )}
                  </div>
                </div>
              </div>

              {/* é€å¸§ç²¾ä¿®å…¨å±å¼¹çª— */}
              {showFrameInspector && (
                  <div className="fixed inset-0 z-50 bg-black/90 backdrop-blur flex items-center justify-center p-4">
                      <div className="bg-gray-800 w-full max-w-4xl h-[90vh] rounded-2xl flex flex-col border border-gray-700 shadow-2xl overflow-hidden">
                          {/* å¼¹çª—å¤´éƒ¨ */}
                          <div className="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900">
                              <div className="flex items-center space-x-3">
                                  <div className="p-2 bg-yellow-600 rounded text-white"><RepairIcon className="w-5 h-5"/></div>
                                  <div>
                                      <h3 className="text-lg font-bold text-white">é€å¸§ç²¾ä¿®æ¨¡å¼</h3>
                                      <p className="text-xs text-gray-400">ç‚¹å‡»ç”»é¢ä¸­çš„æ‚è‰²å³å¯æ¶ˆé™¤ã€‚ä¿®æ”¹ä¼šè‡ªåŠ¨åº”ç”¨åˆ°æœ€ç»ˆç»“æœã€‚</p>
                                  </div>
                              </div>
                              <div className="flex items-center space-x-4">
                                  <div className="text-sm text-gray-300 font-mono bg-black/30 px-3 py-1 rounded">
                                      Frame {currentInspectFrame + 1} / {rawFramesRef.current.length}
                                  </div>
                                  <button onClick={closeInspector} className="p-2 hover:bg-gray-700 rounded-full text-gray-400 hover:text-white transition-colors">
                                      <CloseIcon className="w-6 h-6" />
                                  </button>
                              </div>
                          </div>

                          {/* å¼¹çª—ä¸»ä½“ */}
                          <div className="flex-1 overflow-hidden relative flex flex-col">
                              {/* ç”»å¸ƒåŒºåŸŸ */}
                              <div className="flex-1 bg-black/50 overflow-auto flex items-center justify-center p-8 bg-checkerboard relative">
                                  <canvas 
                                      ref={inspectorCanvasRef} 
                                      className="border border-gray-600 shadow-2xl cursor-crosshair-custom max-w-full max-h-full object-contain"
                                      onClick={handleInspectorClick}
                                  />
                                  {/* æç¤ºæµ®å±‚ */}
                                  <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-black/70 text-white px-4 py-2 rounded-full text-sm pointer-events-none backdrop-blur-sm border border-white/10">
                                      ğŸ‘† ç‚¹å‡»ç”»é¢ä¸­æ®‹ç•™çš„èƒŒæ™¯è‰²ï¼ˆå¦‚ä¸¤è…¿ä¹‹é—´ï¼‰æ¥æ¶ˆé™¤
                                  </div>
                              </div>

                              {/* åº•éƒ¨æ§åˆ¶æ  */}
                              <div className="h-20 bg-gray-900 border-t border-gray-700 flex items-center justify-between px-6">
                                  <div className="flex items-center space-x-4 w-full justify-center">
                                      <button 
                                          onClick={() => setCurrentInspectFrame(Math.max(0, currentInspectFrame - 1))}
                                          disabled={currentInspectFrame === 0}
                                          className="p-3 rounded-full bg-gray-800 hover:bg-gray-700 disabled:opacity-50 text-white transition-all"
                                      >
                                          <ChevronLeftIcon className="w-6 h-6"/>
                                      </button>
                                      
                                      <input 
                                          type="range" 
                                          min="0" 
                                          max={rawFramesRef.current.length - 1} 
                                          value={currentInspectFrame} 
                                          onChange={(e) => setCurrentInspectFrame(Number(e.target.value))}
                                          className="w-full max-w-md h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-yellow-500"
                                      />
                                      
                                      <button 
                                          onClick={() => setCurrentInspectFrame(Math.min(rawFramesRef.current.length - 1, currentInspectFrame + 1))}
                                          disabled={currentInspectFrame === rawFramesRef.current.length - 1}
                                          className="p-3 rounded-full bg-gray-800 hover:bg-gray-700 disabled:opacity-50 text-white transition-all"
                                      >
                                          <ChevronRightIcon className="w-6 h-6"/>
                                      </button>
                                  </div>
                                  
                                  <div className="absolute right-6 flex items-center space-x-3">
                                      {manualSeeds.length > 0 && (
                                          <button 
                                              onClick={() => setManualSeeds([])}
                                              className="px-3 py-2 text-red-400 hover:text-red-300 text-xs flex items-center hover:bg-red-900/20 rounded transition-colors"
                                          >
                                              <TrashIcon className="w-3 h-3 mr-1"/>é‡ç½®æ‰€æœ‰ä¿®è¡¥
                                          </button>
                                      )}
                                      <button 
                                          onClick={closeInspector}
                                          className="px-6 py-2 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg shadow-lg shadow-green-500/20 transition-all transform hover:scale-105 active:scale-95"
                                      >
                                          åº”ç”¨å¹¶ä¿å­˜
                                      </button>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              )}

            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
