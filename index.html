<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频转 GIF/精灵图工具 (支持透明)</title>
    <!-- 引入 Tailwind CSS (样式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel (让浏览器能运行 React 代码) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入 gif.js (核心库) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    
    <style>
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* 隐藏视频但保持渲染 */
        .video-hidden { 
            position: absolute;
            top: -9999px;
            left: -9999px;
            opacity: 0;
            pointer-events: none;
            width: 320px; 
            height: 240px;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // 图标组件
        const FilmIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M7 3v18"/><path d="M3 7.5h4"/><path d="M3 12h18"/><path d="M3 16.5h4"/><path d="M17 3v18"/><path d="M17 7.5h4"/><path d="M17 16.5h4"/></svg>;
        const UploadIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const SettingsIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const ImageIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>;
        const DownloadIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>;
        const AlertCircleIcon = ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;

        const App = () => {
          const [videoUrl, setVideoUrl] = useState(null);
          const [videoMeta, setVideoMeta] = useState({ duration: 0, width: 0, height: 0 });
          
          // 配置参数
          const [outputMode, setOutputMode] = useState('sprite'); // 'sprite' | 'gif'
          const [frameCount, setFrameCount] = useState(12);
          const [scale, setScale] = useState(0.25);
          const [columns, setColumns] = useState(4);
          
          // 状态
          const [isProcessing, setIsProcessing] = useState(false);
          const [progress, setProgress] = useState(0);
          const [generatedImage, setGeneratedImage] = useState(null);
          const [error, setError] = useState(null);

          const videoRef = useRef(null);
          const canvasRef = useRef(null);
          const fileInputRef = useRef(null);

          // 当帧数改变时，自动调整列数
          useEffect(() => {
            if (frameCount > 0 && outputMode === 'sprite') {
              setColumns(Math.ceil(Math.sqrt(frameCount)));
            }
          }, [frameCount, outputMode]);

          const handleFileChange = (event) => {
            const file = event.target.files[0];
            if (file) {
              if (videoUrl) URL.revokeObjectURL(videoUrl);
              const url = URL.createObjectURL(file);
              setVideoUrl(url);
              setGeneratedImage(null);
              setError(null);
              setProgress(0);
            }
          };

          const handleLoadedMetadata = () => {
            if (videoRef.current) {
              setVideoMeta({
                duration: videoRef.current.duration,
                width: videoRef.current.videoWidth,
                height: videoRef.current.videoHeight,
              });
            }
          };

          const seekToTime = (videoElement, time) => {
            return new Promise((resolve) => {
              const timeoutId = setTimeout(() => {
                  console.warn("Seek timeout, forcing next frame");
                  resolve();
              }, 3000);

              const onSeeked = () => {
                clearTimeout(timeoutId);
                videoElement.removeEventListener('seeked', onSeeked);
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        resolve();
                    });
                });
              };
              videoElement.addEventListener('seeked', onSeeked);
              videoElement.currentTime = time;
            });
          };

          // 核心生成逻辑
          const generate = async () => {
            if (!videoRef.current || !canvasRef.current) return;

            setIsProcessing(true);
            setProgress(0);
            setError(null);
            setGeneratedImage(null);

            try {
              const video = videoRef.current;
              const canvas = canvasRef.current;
              const ctx = canvas.getContext('2d', { willReadFrequently: true });

              const totalFrames = parseInt(frameCount);
              const frameWidth = Math.floor(videoMeta.width * scale);
              const frameHeight = Math.floor(videoMeta.height * scale);

              // 准备 GIF 编码器 (如果需要)
              let gif = null;
              if (outputMode === 'gif') {
                  // 动态获取 Worker 代码以避免跨域问题
                  try {
                      const workerBlob = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js').then(r => r.blob());
                      const workerUrl = URL.createObjectURL(workerBlob);
                      
                      gif = new GIF({
                          workers: 2,
                          quality: 10,
                          width: frameWidth,
                          height: frameHeight,
                          workerScript: workerUrl,
                          transparent: 0x000000 // 尝试设置透明键色，虽然 gif.js 自动检测 alpha 更准
                      });
                  } catch (e) {
                      throw new Error("初始化 GIF 组件失败，请检查网络连接（需要访问 CDN）。");
                  }
              }

              // 设置画布尺寸
              if (outputMode === 'sprite') {
                  const cols = parseInt(columns);
                  const rows = Math.ceil(totalFrames / cols);
                  canvas.width = cols * frameWidth;
                  canvas.height = rows * frameHeight;
              } else {
                  // GIF 模式只需要单帧大小的画布
                  canvas.width = frameWidth;
                  canvas.height = frameHeight;
              }

              ctx.clearRect(0, 0, canvas.width, canvas.height);
              
              const interval = videoMeta.duration / (totalFrames + 1);
              
              // 自动计算 GIF 帧延迟 (毫秒)
              // 比如: 10秒视频提取10帧，每帧展示1秒。
              // 加上 10% 的 buffer 使得看起来稍微自然点
              const delay = (interval * 1000); 

              for (let i = 0; i < totalFrames; i++) {
                if (!videoRef.current) break;

                const time = interval * (i + 1);
                await seekToTime(video, time);

                // 确定绘制位置
                let dx = 0, dy = 0;
                if (outputMode === 'sprite') {
                    const cols = parseInt(columns);
                    dx = (i % cols) * frameWidth;
                    dy = Math.floor(i / cols) * frameHeight;
                } else {
                    // GIF 模式每帧都画在 (0,0)，但在画之前要清除上一帧
                    ctx.clearRect(0, 0, frameWidth, frameHeight);
                    dx = 0; 
                    dy = 0;
                }

                if (video.readyState >= 2) {
                    ctx.drawImage(video, 0, 0, videoMeta.width, videoMeta.height, dx, dy, frameWidth, frameHeight);
                    
                    // 如果是 GIF，添加这一帧
                    if (gif) {
                        gif.addFrame(ctx, { copy: true, delay: delay });
                    }
                }
                
                setProgress(Math.round(((i + 1) / totalFrames) * 90)); // 留 10% 给渲染
              }

              // 导出结果
              if (outputMode === 'sprite') {
                  try {
                      const dataUrl = canvas.toDataURL('image/png');
                      setGeneratedImage(dataUrl);
                      setProgress(100);
                  } catch (e) {
                      console.error(e);
                      throw new Error("导出图片失败，可能是浏览器跨域限制。");
                  }
              } else if (gif) {
                  // 渲染 GIF
                  setProgress(95);
                  gif.on('finished', function(blob) {
                      const gifUrl = URL.createObjectURL(blob);
                      setGeneratedImage(gifUrl);
                      setProgress(100);
                  });
                  gif.render();
              }

            } catch (err) {
              console.error(err);
              setError(err.message || "生成失败");
            } finally {
              if (outputMode === 'sprite') {
                  setIsProcessing(false); // GIF 处理在 finished 回调中结束，但这里也需要兜底
              } else {
                  // 对于 GIF，finished 回调会处理
                  // 但如果出错，需要手动关闭
                  if (error) setIsProcessing(false);
              }
              // 为简单起见，我们在 gif.on finished 里关闭 loading，或者这里延迟一下
              if (outputMode === 'sprite') setIsProcessing(false);
            }
          };

          // 监听 GIF 渲染结束，修正上面的 finally 逻辑问题
          useEffect(() => {
              if (progress === 100) {
                  setIsProcessing(false);
              }
          }, [progress]);

          const downloadImage = () => {
            if (generatedImage) {
              const link = document.createElement('a');
              link.href = generatedImage;
              link.download = outputMode === 'sprite' 
                ? `sprite-${Date.now()}.png` 
                : `animation-${Date.now()}.gif`;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
            }
          };

          const formatTime = (seconds) => {
            if (!seconds) return "0:00";
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
          };

          const estimatedW = Math.round(videoMeta.width * scale * (outputMode === 'sprite' ? columns : 1));
          const estimatedH = Math.round(videoMeta.height * scale * (outputMode === 'sprite' ? Math.ceil(frameCount / columns) : 1));

          return (
            <div className="min-h-screen bg-gray-900 text-gray-100 font-sans p-4 md:p-8">
              <div className="max-w-6xl mx-auto space-y-8">
                
                <header className="flex flex-col md:flex-row items-center justify-between border-b border-gray-800 pb-6">
                  <div className="flex items-center space-x-3 mb-4 md:mb-0">
                    <div className="p-3 bg-indigo-600 rounded-lg shadow-lg shadow-indigo-500/20">
                      <FilmIcon className="w-8 h-8 text-white" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-400">
                        视频转 GIF/精灵图
                      </h1>
                      <p className="text-gray-400 text-sm">支持透明背景视频，一键生成 GIF 或 Sprite</p>
                    </div>
                  </div>
                </header>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  
                  <div className="lg:col-span-1 space-y-6">
                    
                    <div 
                      className={`border-2 border-dashed rounded-xl p-8 text-center transition-colors cursor-pointer group ${videoUrl ? 'border-green-500/50 bg-green-500/5' : 'border-gray-700 hover:border-indigo-500 hover:bg-gray-800'}`}
                      onClick={() => fileInputRef.current.click()}
                    >
                      <input 
                        type="file" 
                        ref={fileInputRef} 
                        accept="video/*" 
                        className="hidden" 
                        onChange={handleFileChange} 
                      />
                      {videoUrl ? (
                         <div className="flex flex-col items-center text-green-400">
                            <FilmIcon className="w-10 h-10 mb-2" />
                            <span className="font-medium">视频已加载</span>
                            <span className="text-xs text-gray-400 mt-1">点击更换视频</span>
                         </div>
                      ) : (
                        <div className="flex flex-col items-center text-gray-400 group-hover:text-indigo-400">
                          <UploadIcon className="w-10 h-10 mb-2" />
                          <span className="font-medium">点击上传视频</span>
                          <span className="text-xs text-gray-500 mt-1">支持 MP4, WebM, MOV</span>
                        </div>
                      )}
                    </div>

                    <video 
                      ref={videoRef} 
                      src={videoUrl} 
                      onLoadedMetadata={handleLoadedMetadata} 
                      className="video-hidden" 
                      muted
                      playsInline
                      preload="auto"
                    />

                    <div className="bg-gray-800 rounded-xl p-6 border border-gray-700 space-y-6">
                      <div className="flex items-center space-x-2 text-lg font-semibold text-white mb-2">
                        <SettingsIcon className="w-5 h-5 text-indigo-400" />
                        <span>生成设置</span>
                      </div>

                      {/* 模式选择 */}
                      <div className="bg-gray-900 p-1 rounded-lg flex space-x-1">
                          <button 
                            onClick={() => setOutputMode('sprite')}
                            className={`flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all ${outputMode === 'sprite' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                          >
                            PNG 精灵图
                          </button>
                          <button 
                            onClick={() => setOutputMode('gif')}
                            className={`flex-1 py-2 px-3 text-sm font-medium rounded-md transition-all ${outputMode === 'gif' ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}
                          >
                            GIF 动图
                          </button>
                      </div>

                      <div>
                        <div className="flex justify-between mb-2">
                          <label className="text-sm text-gray-300">提取帧数 (Frames)</label>
                          <span className="text-sm font-mono text-indigo-400">{frameCount}</span>
                        </div>
                        <input 
                          type="range" 
                          min="1" 
                          max="300" 
                          step="1"
                          value={frameCount} 
                          onChange={(e) => setFrameCount(Number(e.target.value))} 
                          className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                        />
                      </div>

                      <div>
                        <div className="flex justify-between mb-2">
                          <label className="text-sm text-gray-300">图片缩放 (Scale)</label>
                          <span className="text-sm font-mono text-indigo-400">{Math.round(scale * 100)}%</span>
                        </div>
                        <input 
                          type="range" 
                          min="0.05" 
                          max="1.0" 
                          step="0.05"
                          value={scale} 
                          onChange={(e) => setScale(Number(e.target.value))} 
                          className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                        />
                        <p className="text-xs text-gray-500 mt-1">
                          单帧尺寸: {Math.round(videoMeta.width * scale)} x {Math.round(videoMeta.height * scale)} px
                        </p>
                      </div>

                      {/* 只有精灵图模式才显示列数 */}
                      {outputMode === 'sprite' && (
                          <div>
                            <div className="flex justify-between mb-2">
                              <label className="text-sm text-gray-300">每行列数 (Columns)</label>
                              <span className="text-sm font-mono text-indigo-400">{columns}</span>
                            </div>
                            <input 
                              type="range" 
                              min="1" 
                              max={frameCount} 
                              step="1"
                              value={columns} 
                              onChange={(e) => setColumns(Number(e.target.value))} 
                              className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-indigo-500"
                            />
                          </div>
                      )}

                      {videoUrl && (
                        <div className="p-3 rounded text-xs space-y-1 bg-gray-900 border-transparent text-gray-400">
                          <div className="flex justify-between">
                            <span>原视频时长:</span>
                            <span>{formatTime(videoMeta.duration)}</span>
                          </div>
                          <div className="flex justify-between pt-1">
                            <span>{outputMode === 'sprite' ? '预计大图尺寸' : 'GIF 尺寸'}:</span>
                            <span className="font-mono text-indigo-300">
                              {estimatedW} x {estimatedH} px
                            </span>
                          </div>
                        </div>
                      )}

                      <button 
                        onClick={generate}
                        disabled={!videoUrl || isProcessing}
                        className={`w-full py-3 px-4 rounded-lg font-bold text-white transition-all flex items-center justify-center space-x-2
                          ${!videoUrl 
                            ? 'bg-gray-700 cursor-not-allowed text-gray-500' 
                            : isProcessing 
                              ? 'bg-indigo-700 cursor-wait opacity-80' 
                              : 'bg-indigo-600 hover:bg-indigo-500 hover:shadow-lg hover:shadow-indigo-500/25 active:transform active:scale-95'
                          }`}
                      >
                        {isProcessing ? (
                          <>
                            <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                            <span>
                                {progress < 100 ? `处理中 ${progress}%` : '最终渲染中...'}
                            </span>
                          </>
                        ) : (
                          <>
                            <ImageIcon className="w-5 h-5" />
                            <span>{outputMode === 'sprite' ? '生成精灵图' : '生成 GIF 动图'}</span>
                          </>
                        )}
                      </button>
                    </div>
                  </div>

                  <div className="lg:col-span-2 bg-gray-800 rounded-xl border border-gray-700 p-1 overflow-hidden flex flex-col h-[600px] lg:h-auto">
                     <div className="bg-gray-900 border-b border-gray-700 p-3 flex justify-between items-center">
                        <h2 className="text-sm font-medium text-gray-300">
                            预览结果 ({outputMode === 'sprite' ? 'PNG' : 'GIF'})
                        </h2>
                        {generatedImage && (
                          <button 
                            onClick={downloadImage}
                            className="bg-green-600 hover:bg-green-500 text-white text-xs px-3 py-1.5 rounded flex items-center space-x-1 transition-colors"
                          >
                            <DownloadIcon className="w-3 h-3" />
                            <span>下载 {outputMode === 'sprite' ? 'PNG' : 'GIF'}</span>
                          </button>
                        )}
                     </div>

                     <div className="flex-1 overflow-auto bg-gray-900/50 p-4 relative flex items-center justify-center custom-scrollbar">
                        <canvas ref={canvasRef} className="hidden" />

                        {error && (
                          <div className="text-red-400 flex flex-col items-center text-center max-w-md p-4 bg-red-900/20 rounded-lg border border-red-500/30">
                            <AlertCircleIcon className="w-8 h-8 mb-2" />
                            <p className="font-medium">出错了</p>
                            <p className="text-sm opacity-80 mt-1">{error}</p>
                          </div>
                        )}

                        {!generatedImage && !isProcessing && !error && (
                           <div className="text-gray-600 flex flex-col items-center">
                              <div className="w-16 h-16 border-2 border-dashed border-gray-700 rounded-lg mb-2 flex items-center justify-center">
                                <ImageIcon className="w-6 h-6" />
                              </div>
                              <p className="text-sm">预览将显示在这里</p>
                           </div>
                        )}

                        {isProcessing && (
                          <div className="absolute inset-0 flex flex-col items-center justify-center bg-gray-900/80 z-10 backdrop-blur-sm">
                             <div className="w-64 h-4 bg-gray-700 rounded-full overflow-hidden mb-2">
                                <div 
                                  className="h-full bg-indigo-500 transition-all duration-300 ease-out"
                                  style={{ width: `${progress}%` }}
                                ></div>
                             </div>
                             <p className="text-indigo-300 text-sm font-mono animate-pulse">
                                {outputMode === 'gif' && progress > 90 ? '正在编码 GIF (可能需要几秒)...' : `正在提取帧: ${progress}%`}
                             </p>
                          </div>
                        )}
                        
                        {generatedImage && (
                          <img 
                            src={generatedImage} 
                            alt="Generated Output" 
                            className="max-w-none shadow-2xl border border-gray-700 bg-[url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAMUlEQVQ4T2NkYGAQYcAP3uCTZhw1gGGYhAGBZIA/nYDCgBDAm9BGDWCEAvgUGjZGYwIAxuoHr4hHvAQAAAAASUVORK5CYII=')] bg-repeat" 
                            /* 上面加了一个棋盘格背景，方便看透明效果 */
                          />
                        )}
                     </div>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
